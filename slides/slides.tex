\documentclass[serif,slidestop,compress,red]{beamer}
%\usepackage[utf8]{inputenc}
\usepackage{caption}
\usepackage{listings}

\usetheme{Antibes}

\usepackage{fontspec}
%\fontspec{Ubuntu}
%\fontspec{Helsinki}
%\fontspec{Vollkorn}
\usepackage{xltxtra}
\setmainfont{Ubuntu}
\setmonofont{Courier 10 Pitch}
\setromanfont{Ubuntu}
\setsansfont{Ubuntu}

\beamertemplatenavigationsymbolsempty

\title{Control-Flow Integrity Checking}
\subtitle{Vortrag im Hauptseminar Betriebssysteme}
\author{Hermann Loose}

\definecolor{light-gray}{gray}{0.7}

\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{\colorbox{gray}{\parbox{\textwidth}{\hspace{0.9em}#1#2#3}}}
\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white,font={sf}}

\begin{document}

\definecolor{keywords}{RGB}{255,0,90}
\definecolor{comments}{RGB}{100,100,100}
\lstset{
  language=[x86masm]Assembler,
  basicstyle=\ttfamily
  %frame=lines
}

\frame[plain]{\titlepage}

\section{Control-Flow Integrity}

\subsection{Überblick}

\begin{frame}
  \frametitle{Angreifermodell}
  \begin{itemize}
    \item volle Kontrolle über Datensegment
    \item mögliche Kontrolle über Modul oder Thread im selben Adressraum
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Anwendbarkeit für Angriffsszenarien}
  \begin{itemize}
    \item klassische, Stack-basierte Pufferüberläufe
    \item Heap-basierte jump-to-\texttt{libc} Angriffe
  \end{itemize}
  Für ein vereinfachtes Maschinenmodell existiert ein formaler Beweis in [2].
\end{frame}

\begin{frame}
  \frametitle{Control-Flow Graph (CFG)}
  \begin{itemize}
    \item bestimmt erlaubte Ausführungsreihenfolgen
    \item muss im Vorhinein feststehen:
    \begin{itemize}
      \item Analyse von Quellcode
      \item Analyse von Binaries
      \item Profiling der Ausführung
      \item als Ausdruck einer vorgegebenen Security Policy
    \end{itemize}
    \item hier: statische Analyse von Binaries
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Annahmen}
  \begin{itemize}
    \item[UNQ] Unique IDs
    \begin{itemize}
      \item IDs kommen nicht zufällig im Codesegment vor
      \item Größe des Suchraumes, z.B. 32 Bit
    \end{itemize}
    \item[NWC] Non-Writable Code Memory
    \begin{itemize}
      \item auf den meisten Systemen gegeben
    \end{itemize}
    \item[NXD] Non-Executable Data Memory
    \begin{itemize}
      \item in Hardware auf x86
      \item in Software möglich\footnote{PaX — http://pax.grsecurity.net}
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Instrumentierung}
  \begin{itemize}
    \item entsprechend dem CFG
    \item umfasst Quell- und alle möglichen Zielinstruktionen von Sprüngen mit berechnetem Ziel
    \item vor jedem Ziel eine \texttt{label}-Instruktion mit der ID der Äquivalenzklasse des Ziels
  \end{itemize}
\end{frame}

\subsection{Implementierung}

\begin{frame}[fragile]
  \frametitle{Ausgangspunkt}
  \begin{lstlisting}[title=Quelle]



  jmp ecx              ; computed jump
  \end{lstlisting}
  \begin{lstlisting}[title=Ziel]

  mov eax, [esp+4]     ; dst
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Instrumentierung — Variante 1}
  \begin{lstlisting}[title=Quelle]
  cmp [ecx], 12345678h ; comp ID & dst
  jne error_label      ; if != fail
  lea ecx, [ecx+4]     ; skip ID at dst
  jmp ecx              ; jump to dst
  \end{lstlisting}
  \begin{lstlisting}[title=Ziel]
  ; data 12345678h     ; ID
  mov eax, [esp+4]     ; dst
  \end{lstlisting}
\end{frame}

%\begin{frame}[fragile]
%  \frametitle{Quelle — erster Versuch}
%  \begin{lstlisting}
%  cmp [ecx], 12345678h ; 81 39 78 56 34 12
%  jne error_label      ; 75 13
%  lea ecx, [ecx+4]     ; 8D 49 04
%  jmp ecx              ; FF E1
%  \end{lstlisting}
%\end{frame}

\begin{frame}[fragile]
  \frametitle{Instrumentierung — Variante 1}
  \begin{lstlisting}[title=Quelle,escapechar=!]
  cmp [ecx], !\colorbox{light-gray}{12345678h}! ; 81 39 !\emph{\colorbox{light-gray}{78 56 34 12}}!
  jne error_label      ; 75 13
  lea ecx, [ecx+4]     ; 8D 49 04
  jmp ecx              ; FF E1
  \end{lstlisting}
  \textbf{Problem:} die ID ist in die \texttt{cmp} Instruktion eingebettet, \\ macht
  damit \texttt{jne error\_label} zu einem gültigen Ziel
\end{frame}

\begin{frame}[fragile]
  \frametitle{Instrumentierung — Variante 2}
  \begin{lstlisting}[title=Quelle]
  mov eax, 12345677h ; load ID-1
  inc eac            ; increment ID
  cmp [ecx+4], eax   ; compare w/ dst
  jne error_label    ; if != fail
  jmp ecx            ; jump to label
  \end{lstlisting}
  \begin{lstlisting}[title=Ziel]
  prefetchnta        ; label
     [12345678h]     ;    ID
  mov eax, [esp+4]   ; dst
  \end{lstlisting}
\end{frame}

\subsection{CFI als Basis für andere Mechanismen}

\begin{frame}
  \frametitle{CFI als Grundlage für IRMs}
\end{frame}

\begin{frame}
  \frametitle{SMAC: Generalized SFI}
\end{frame}

\section{Software Signatures}

\section{}

\begin{frame}
  \frametitle{Quellen}
  \begin{enumerate}
    \item \emph{Control-Flow Integrity} \\ M. Abadi, M. Budiu, Ú. Erlingsson, J. Ligatti — 2005
    \item \emph{A Theory of Secure Control Flow} \\ M. Abadi, M. Budiu, Ú. Erlingsson, J. Ligatti — 2005
    \item \emph{Control-Flow Checking by Software Signatures} \\ N. Oh, P. Shirvani, E. McCluskey — 2000
  \end{enumerate}
\end{frame}

\end{document}
